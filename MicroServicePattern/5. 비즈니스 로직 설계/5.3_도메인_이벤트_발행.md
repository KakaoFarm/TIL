# 5.3 도메인 이벤트 발행

-   DDD 맥락에서 도메인 이벤트는 애그리거트에 발생한 사건.
-   도메인 이벤트는 도메인 모델에서는 클래스로 표현되며, 대부분 어떤 상태 변경을 나타냄
-   애그리거트는 뭔가 생성되거나 중요한 변경이 발생했을 때 도메인 이벤트를 발행.

<br />

## 5.3.1 변경 이벤트를 발행하는 이유

다른 구성원(사용자, 다른 애플리케이션 또는 같은 애플리케이션 내부의 다른 컴포넌트)들이 애그리거트의 상태 변경을 궁금해하기 때문.

### 상황

-   코레오그래피 사가를 이용하여 여러 서비스에 걸쳐 데이터 일관성을 유지.
-   레플리카를 둔 서비스에 소스 데이터가 변경되었음을 알림.
-   미리 등록된 웹훅이나 메시지 브로커를 통해 비즈니스 프로세스의 다음단계를 진행하도록 알림.
-   사용자 브라우저에 웹 소켓 메시지, Elastic Search 같은 텍스트 DB를 업데이트 하기 위해.
-   사용자에게 text 형식으로 알릴 때
-   애플리케이션이 제대로 작동되고 있는지 도메인 이벤트를 모니터링.
-   사용자 행동을 모델링하기 위해 이벤트 분석

<br />

## 5.3.2 도메인 이벤트란 무엇인가?

도메인 이벤트는 과겨 분사향 동사로 명명한 클래스.

### 프로퍼티

이벤트에 의미 부여

-   원시 값(primitive value)
-   밸류 객체(value object)

### 메타데이터

-   상위 클래스에 정의된 이벤트 객체의 일부이거나, 이벤트 객체를 감산 엔벨로프 객체(envelope object)에 있음.
-   변경을 일으킨 사용자 신원 정보를 넣기도 하는데, 감사(audit) 용도로 좋음.
-   이벤트 ID
-   타임 스탬프

<br />

## 5.3.3 이벤트 강화

`이벤트 강화(event enrichment)`: 컨슈머에 필요한 정보를 이벤트에 갖고 다니는 기법.

### 이벤트 강화 장점

-   이벤트를 발생한 서비스를 다시 쿼리해서 데이터를 가져올 필요가 없음.
-   컨슈머의 단순화

### 이벤트 강화 단점

-   컨슈머 요건이 바뀌면 이벤트 클래스도 함께 바꿔야 하므로 이벤트 클래스의 안정성이 떨어짐.
-   변경할 일이 생기면 애플리케이션 곳곳에 영향이 있을 수도 있어 유지보수성이 나쁨.

<br />

## 5.3.4 도메인 이벤트 식별

### 요건 정의서

알림이 필요한 시나리오를 `"X가 일어나면 Y를 수행하라"` 라는 식으로 보통 기술.

### 이벤트 스토밍

많이 사용하는 방법으로 `복잡한 도메인을 이해하기 위해 이벤트 중심으로 워크숍을 하는 것`.

1. `이벤트 브레인스토밍(event brainstorming)`: 도메인 이벤트를 생각하고, 오렌지색 점착식 메모지로 구분된 도메인 이벤트를 모델링 화면에 그려놓은 타임라인에 배치.
2. `이벤트 트리거(event trigger) 식별`: 각각의 이벤트를 일으키는 트리거를 식별

    - 사용자 액션: 파란색 점착식 메모지로 커맨드 표시
    - 외부 시스템: 자주색 점착식 메모지로 표시
    - 기타 도메인 이벤트
    - 시간 경과

3. `애그리거트 식별`: 각 커맨드 소비 후 적절한 이벤트를 발생시키는 애그리거트를 식별해서 노락색 점착식 메모지로 표시

<br />

## 5.3.5 도메인 이벤트 생성 및 발행

도메인 이벤트는 애그리거트를 발행하고, 애그리거트는 자신의 상태가 변경되는 시점과 그 결과 어떤 이벤트를 발행할지 알고 있다.

### 방법

-   애그리거트와 호출하는 서비스(또는 그와 동등한 클래스)의 책임을 분리
    -   `서비스`: 디펜던시를 주입하여 메시징 API를 가리키는 레퍼런스를 획득하여 이벤트를 발행하기가 더 쉬워짐.
    -   `애그리거트`: 상태 전이 시 이벤트를 생성하고, 이렇게 생성한 이벤트를 반환.
        -   애그리거트 메서드 반환값에 이벤트 목록을 넣음
        -   에그리거트 루트의 특정 필드에 이벤트를 쌓아두고 서비스가 이벤트를 가져다 발행

### 도메인 이벤트르르 확실하게 발행하는 방법

-   서비스는 DB에서 애그리거트를 업데이트하는 트랜잭션의 일부로 이벤트를 발행하기 위해 트랜잭셔널 메시징을 사용.

<br />

## 5.3.6 도메인 이벤트 소비

도메인 이벤트는 메시지로 바뀌어 아파치 카프가 같은 메시지 브로거에 발행.

1. 브로커가 제공하는 클라이언트 API를 컨슈머가 직접 사용
2. 이벤추에이트 트램 프레임워크에 있는 DomainEventDispatcher 같은 고수준 API를 써서 도메인 이벤트를 적절한 핸들러 메서드로 디스패치하는 것이 더 쉬움.
