# 7.2 CQRS 패턴

엔터프라이즈 애플리케이션은 대부분 RDBMS에 트랜잭션을 걸어 레코드를 관리하고, 텍스트 검색 쿼리는 elastic search나 솔라 등의 텍스트 검색 DB를 이용해서 구현

-   여러 DB의 장점을 최대한 활용하자는 의도.
-   RDBMS 특유의 트랜잭션 기능과 텍스트 검색 DB의 탁월한 쿼리 능력을 융합하여 활용

<b>CQRS</b>: (텍스트 검색 DB 뿐만 아니라) 하나 이상의 쿼리가 구현된 하나 이상의 뷰 DB를 유지하는 기법.

<b>패턴: 커맨드 쿼리 책임 분리</b>: 여러 서비스에 있는 데이터를 가져오는 쿼리는 이벤트를 이용하여 해당 서비스의 데이터를 복제한 읽기 전용 뷰를 유지.

<br />

## 7.2.1 CQRS의 필요성

API 조합 패턴으로 구현하기 어려운 다중 서비스 쿼리가 존재.

### findOrderHistory() 쿼리 구현

findOrderHistory()는 소비자의 주문 이력을 조회하는 쿼리작업.

-   consumerId: 소비자 식별자
-   OrderHistoryFilter: 필터 조건. 어느 시점 이후 주문까지 반환할 것인가(필수), 주문 상태(옵션), 음식점명 및 메뉴 항목을 검색할 키워드(옵션)

<b>API 조합기로 간단히 구현될 것 같지만 모든 서비스가 필터/정렬 용도의 속성을 보관하는 것이 아니기 때문에 불가능</b>

#### API 조합기의 해결방법

1. API 조합기로 데이터를 인-메모리 조인을 한다.

    - 모든 주문 데어터를 배달 서비스, 회계 서비스에서 가져온 후 주문 서비스, 주방 서비스에서 가져온 데이터와 조인
    - 거대한 데이터 뭉치를 이런식으로 API 조합기에서 조인하면 급격히 효율이 떨어짐.

2. API 조합기로 주문 서비스, 주방 서비스에서 데이터를 조회하고, 주문 ID를 이용하여 다른 서비스에 있는 데이터를 요청
    - 대랑 조회 API를 제공할 경우 현실성 있지만 주문 데이터를 하나하나 요청하는 것은 과도한 네트워크 트래픽이 유발되므로 비효율적

### 어려운 단일 서비스 쿼리: findAvailableRestaurants()

여러 서비스에서 데이터를 가져오는 쿼리만 어려운 것이 아니라, 하나의 서비스에 국한된 쿼리도 구현하기 어려운 경우가 있음.

-   데이터를 가진 서비스에 쿼리를 구현하는 것이 부적절한 경우가 있음.
-   서비스 DB가 (또는 데이터 모델이) 효율적인 쿼리를 지원하지 않기 때문 ex)지리 공간 쿼리는 MongoDB, Postgres, MySQL 에서 제공하지만 다른 DB는 제공하지 않음.

### 관심사를 분리할 필요성

-   데이터를 가진 서비스에 쿼리를 구현하면 안 될 때가 있기 때문.
-   관심사를 어떻게 분리하면 좋을지, 어느 한 서비스에 너무 많은 책임을 부과하지 않으려면 어떻게 해야 할지에 대한 문제가 고민

<br />

## 7.2.2 CQRS 개요

### 3개의 난관

-   API를 조합하여 여러 서비스에 흩어진 데이터를 조회하려면 값비싸고 비효율적인 인-메모리 조인을 해야 한다.
-   데이터를 가진 서비스는 필요한 쿼리를 효율적으로 지원하지 않는 DB에, 또는 그런 형태로 데이터를 저장
-   관심사를 분리할 필요가 있다는 것은 데이터를 가진 서비스가 쿼리 작업을 구현할 장소로 적합하지 않다는 것.

-   <b> CQRS로 해결 가능</b>

### CQRS는 커맨드와 쿼리를 서로 분리한다.

영속적 데이터 모델과 그것을 사용하는 모듈을 `커맨드`와 `쿼리`, 두 편으로 가름.

-   쿼리 쪽 모듈 및 데이터 모델 : `조회(R)` 기능. ex) HTTP GET
-   커맨드 쪽 모듈 및 데이터 모델: `생성/수정/삭제(CUD)` 기능 ex) HTTP POST, PUT, DELETE
-   양쪽 데이터 모델 사이의 동기화는 커맨드 쪽에서 발행한 이벤트를 쿼리 쪽에서 구독하는 식으로 이루어짐.

#### 비CQRS

-   전체 CRUD를 처리하는 단일 DB 가지고 있음.

#### CQRS

-   CUD용 DB와 쿼리용 DB 분리
-   커맨드 쪽 DB가 변경될 때마다 발행되는 이벤트를 구독하여 항상 최신 상태로 유지
