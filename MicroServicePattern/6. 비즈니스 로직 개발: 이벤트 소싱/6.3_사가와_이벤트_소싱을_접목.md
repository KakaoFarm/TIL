# 6.3 사가와 이벤트 소싱을 접목

사가와 이벤트 소싱 기반의 비즈니스 로직을 연계.

-   이벤트 소싱에서는 코레오그래피 사가를 쉽게 이용
-   이벤트 소싱 기반의 비즈니스 로직을 오케스트레이션 기반의 사가에 연계하는 일은 어려움.
    -   이벤트 저장소의 트랜잭션 개념이 상당히 제한적

### 사가에서 반드시 원자적으로 수행되어야 하는 액션

-   <b>사가 생성</b>: 사가를 시작한 서비스는 원자적으로 애그리거트를 생성/수정하고 사가 오케스트레이터를 생성해야 한다.
-   <b>사가 오케스트레이션</b>: 사가 오케스트레이터는 원자적으로 응답을 소비하고, 자신의 상태를 업데이트한 후 커맨드 메시지를 전송해야 한다.
-   <b>사가 참여자</b>: 사가 참여자는 원자적으로 메시지를 소비하고, 중복 메시지를 솎아 내고, 애그리거트를 생성/수정하고, 응답 메시지를 전송해야 한다.

-   이벤트 저장소의 RDBMS/NoSQL 사용 여부는 이벤트 소싱과 오케스트레이션 사가의 연계 가능성을 가늠하는 핵심 기준

<br />

## 6.3.1 코레오그래피 사가 구현: 이벤트 소싱

이벤트 소싱은 속성상 이벤트가 모든 것을 주도하므로 코레오그래피 사가를 쉽게 구현 가능

### 방법

1. 애그리거트가 업데이트되면 사가가 이벤트를 발생시킴.
2. 제각기 배정된 이벤트 핸들러는 해당 이벤트를 소비한 후 애그리거트를 업데이트
3. 이벤트 소싱 프레임워크는 각 이벤트 핸들러를 알아서 멱등하게 만듬.

### 장점

-   이벤트 소싱은 메시징 기반의 IPC, 메시지 중복 제거, 원자적 상태 업데이트와 메시지 전송 등 사가가 필요로 하는 여러가지 매커니즘 제공

### 단점

-   이벤트의 목적이 이원화됨.
-   이벤트 소싱은 상태 변화를 나타내기 위해 이벤트를 이용하지만 이벤트를 사가 코레오그래피에 적용시 애그리거트는 상태 변화가 없어도 무조건 이벤트를 발생시켜야 함.

<b>`결론은 오케스트레이션 사가를 구현하자!!`</b>
