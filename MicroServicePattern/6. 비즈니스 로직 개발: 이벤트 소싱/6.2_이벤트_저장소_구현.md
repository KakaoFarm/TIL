# 6.2 이벤트 저장소 구현

<b>이벤트 저장소</b>: DB + 메시지 브로커

-   애그리거트의 이벤트를 기본키로 삽입/조회하는 API가 있어 DB처럼 작동
-   이벤트를 구독하는 API가 있어서 메시지 브로커처럼 작동

### 이벤트 저장소 구현 방법

-   이벤트 저장소와 이벤트 소싱 프레임워크를 직접 구현
    -   RDBMS에 이벤트를 그냥 저장
-   성능/확장성이 우수한 다기능의 전용 이벤트 저장소를 두기

### 전용 이벤트 저장소

-   <b>이벤트 스토어(Event store)</b>: 닷넷 기반의 오픈 소스 이벤트 저장소
-   <b>라곰(Lagom)</b>: 타입세이프(Typesafe)가 전신이 라이트벤드사가 개발한 마이크로서비스 프레임워크
-   <b>액속(Axon)</b>: 이벤트 소싱 및 CQRS를 사용하는 이벤트 주도형 애플리케이션을 위한 오픈 소스 자바 프레임워크
-   <b>이벤추에이트(Eventuate)</b>: 클라우드 서비스인 `이벤추에이트 사스(Eventuate Saas)` 와 아파치 카프카/RDBMS 기반의 오프소스 프로젝트인 `이벤추에이트 로컬(Eventuate Local)`

<br />

## 6.2.1 이벤추에이트 로컬 이벤트 저장소의 작동 원리

`아키텍처: [그림 6-9]`

-   <b>MySQL 등의 DB</b>: 이벤트 저장
-   <b>애플리케이션</b>: 애그리거트 이벤트를 기본키로 조회/삽입하고, 아파치 카프카 등의 메시지 브로커에서 이벤트를 가져와 소비
-   <b>트랜잭션 로그 테일링 장치</b>: DB에서 메시지 브로커로 이벤트를 퍼 나름.

### 이벤추에이트 로컬의 이벤트 DB 스키마

<b>events 테이블</b>

-   이벤트를 저장
-   triggering_event: 중복 이벤트/메시지를 발견하는 용도의 column

```sql
create table events (
    event_id varchar(1000) PRIMARY KEY,
    event_type varchar(1000),
    event_data varchar(1000) NOT NULL,
    entity_type VARCHAR(1000) NOT NULL,
    entity_id VARCHAR(1000) NOT NULL,
    triggering_event VARCHAR(1000)
)
```

<b>entites 테이블</b>

-   엔터티별 현재 버전을 저장, 낙관적 잠금을 구현하는 용도로 사용
-   엔터티가 업데이트될 때마다 entity_version column도 업데이트

```sql
create table entities (
    entity_type VARCHAR(1000),
    entity_id VARCHAR(1000),
    entity_version VARCHAR(1000) NOT NULL,
    PRIMARY KEY(entity_type, entity_id)
)
```

<b>snapshots 테이블</b>

-   엔터티별 스냅샷을 저장하는 테이블

```sql
create table snapshots (
    entity_type VARCHAR(1000),
    entity_id VARCHAR(1000),
    entity_version VARCHAR(1000),
    snapshot_type VARCHAR(1000) NOT NULL,
    snapshot_json VARCHAR(1000) NOT NULL,
    triggering_events VARCHAR(1000),
    PRIMARY KEY(entity_type, entity_id, entity_version)
)
```

<b>find()로 조회한 이후로 버전 변경 감지</b>

```sql
UPDATE entities SET entity_version = ?
WHERE entity_type = ? and entity_id = ? and entity_version = ?
```

### 이벤추에이트 로컬의 이벤트 브로커를 구독하여 이벤트를 소비

-   이벤트 브로커에는 애그리커트 종류마다 `토픽(파티셔닝된 메시지 채널)`이 있음.
-   애그리커트 ID를 파티션 키로 사용하기 때문에 애그리거트가 발행한 이벤트 순서로 보존

### 이벤추에이트 로컬 이벤트 릴레이가 이벤트를 DB에서 메시지 브로커로 전파

-   이벤트 릴레이는 이벤트 DB에 삽입된 이벤트를 이벤트 브로커로 전파
-   이벤트 릴레이는 `스탠드얼론 프로세스`로 배포
-   이벤트 저장소는 `이벤트 DB`, `메시지 브로커`, `이벤트 릴레이`로 구성

<br />

## Reference

-   [stand alone 방식과 xinetd방식](https://jingjingee.tistory.com/14)
