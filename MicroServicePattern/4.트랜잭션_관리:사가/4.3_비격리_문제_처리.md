# 4.3 비격리 문제 처리

-   ACID의 격리성(I): 동시에 실행 중인 여러 트랜잭션의 결과가 어떤 순서대로 실행된 결과와 동일함을 보장하는 속성.
-   사가는 격리성이 빠져있음.

### 격리성 문제

-   한 사가가 실행 중에 접근하는 데이터를 도중에 다른 사가가 바꿔치기할 수 있다.
-   한 사가가 업데이트를 하기 이전 데이터를 다른 사가가 읽을 수 있어서 데이터의 일관성이 깨질 수 있음.

### ACID

-   원자성(Atomicity): 사가는 트랜잭션을 모두 완료하거나 모든 변경분을 언두해야 함.
-   일관성(Conistency): 서비스 내부의 참조 무결성은 로컬 DB, 여러 서비스에 걸친 참조 무결성은 서비스가 처리
-   지속성(Durability): 로컬 DB로 처리

<br />

## 4.3.1 비정상 개요

-   소실된 업데이트(lost updates) : 한 사가의 변경분을 다른 사가가 미처 못 일고 덮어 씁니다.
-   더티 읽기(dirty reads): 사가 업데이트를 하지 않은 변경분을 다른 트랜잭션이나 사가가 읽습니다.
-   퍼지/반복 불가능한 읽기(fuzzy/nonrepeatable): 한 사가의 상이안 두 단계가 같은 데이터를 읽어도 결과가 달라지는 현상.

### 소실된 업데이트

상황

1. 주문 생성 사가 첫 번째 단계에서 주문을 생성
2. 사가 실행 중 주문 취소 사가가 주문을 취소
3. 주문 생성 사가 마지막 단계에서 주문을 승인

### 더티 읽기

상황

1. 주문 취소 사가와 주문 생성 사가의 실행이 서로 겹쳐 실행
2. 소비자가 배달을 취소하기는 너무 늦어서 주문 취소 사가가 롤백
3. 소비자 서비스를 호출하는 트랜잭션 순서가 엉킴.

<br />

## 4.3.2 비격리 대책

-   개발자는 비격리로 인한 비정상을 방지하고 비즈니스에 미치는 영향을 최소화 하는 방향으로 사가를 작성할 의무가 있음.
-   `*_PENDING 상태` : 현재 주문을 사가로 업데이트하는 중이니 그에 맞게 행동하라고 다른 사가에게 알리는 것.

### Semantic ACID properties in multidatabases using remote procedure calls and update prop agations

-   시맨틱 락(semantic lock): 애플리케이션 수준의 락
-   교환적 업데이트(commutative updates): 업데이트 작업은 어떤 순서로 실행해도 되게끔 설계
-   비관적 관점(pessimistic view): 사가 단계 순서를 재조정하여 비즈니스 리스크를 최소화
-   값 다시 읽기(reread value): 데이터를 덮어 쓸 때 그 전에 변경된 내용은 없는지 값을 다시 읽고 확인하여 더티 쓰기 방지
-   버전 파일(version file): 순서를 재조정할 수 있게 업데이트를 기록
-   값에 의한(by value): 요청별 비즈니스 위험성을 기준으로 동시성 매커니즘을 동적 선택.

### 사가의 구조

-   보상 가능 트랜잭션(compensatable trasaction): 보상 트랜잭션으로 롤백 가능한 트랜잭션
-   피봇 트랜잭션(pivot transaction): 사가의 진행/중단 지점. 피봇 트랜잭션이 커밋되면 사가는 완료될때까지 실행.
-   재시도 가능 트랜잭션(retriable transaction): 피봇 트랜잭션 직후의 트랜잭션. 반드시 성공
