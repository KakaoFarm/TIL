# 4.2 사가 편성

사가 편성 로직

-   코레오그래피(choreography): 의사 결정과 순서화를 사가 참여자에게 맡김. 사가 참여자는 주로 이벤트 교환 방식으로 통신.
-   오케스트레이션(orchestration): 사가 편성 로직을 사가 오케스트레이터에 중앙화. 사가 오케스트레이터는 사가 참여자에게 커맨드 메시지를 보내 수행할 작업을 지시.

<br />

## 4.2.1 코레오그래피 사가

사가 참여자가 할 일을 알려 주는 중앙 편성자가 없다. 대신 사가 참여자가 서로 이벤트를 구독해서 그에 따라 반응.

### 주문 생성 사가 구현: 코레오그래피 스타일

사가 참여자는 서로 이벤트를 교환하여 통신.
<img src="https://thebook.io/img/007035/163.jpg">

### 확실한 이벤트 기반 통신

#### 2 가지의 통신 이슈

1.  사가 참여자가 자신의 DB를 업데이트하고, DB 트랜잭션의 일부로 이벤트를 발행하도록 해야 한다.

    -   DB를 업데이트하는 작업과 이벤트를 발행하는 작업은 원자적으로 일어나야 한다.
    -   사가 참여자가 서로 확실하게 통신하려면 트랜잭셔널 메시징 사용.

2.  사가 참여자는 자신이 수신한 이벤트와 자신이 가진 데이터를 연관 지을 수 있어야 한다.
    -   데이터를 매핑할 수 있도록 다른 사가 참여자가 상관관계 ID가 포함된 이벤트를 발행.

### 코레오그래피 사가의 장단점

#### 장점

-   단순함: 비즈니스 객체를 생성, 수정, 삭제할 때 서비스가 이벤트를 발행
-   느슨한 결합: 참여자는 이벤트를 구독할 뿐 서로를 직접 알지 못함.

#### 단점

-   이해하기 어렵다: 여러서비스에 구현 로직이 흩어져 있음.
-   서비스 간 순환 의존성: 참여자가 서로 이벤트를 구독하는 특성 상 잠재적인 설계 취약점.
-   단단히 결합될 위험성: 사가 참여자는 각자 자신에게 영향을 미치는 이벤트를 모두 구독해야 함.

<br />

## 4.2.2 오케스트레이션 사가

-   주문 서비스에 구현된 사가 오케스트레이터는 비동기 요청/응답을 통해 사가 참여자를 호출

<img src="https://thebook.io/img/007035/167.jpg">

### 사가 오케스트레이터를 상태 기계로 모델링

-   상태기계(state machine): 상태(state)와 이벤트에 의해 트리거되는 상태 전이(transition)로 구성
-   액션(action): 전이가 발생할 때마다 일어나며, 사가 참여자를 호출하는 작용.
-   상태 간 전이: 사가 참여자가 로컬 트랜잭션을 완료하는 시점에 트리거, 로컬 트랜잭션의 상태와 결과에 따라 상태 전이를 어떻게 하고 어떤 액션을 취할지 결정

<img src="https://thebook.io/img/007035/169.jpg">

### 사가 오케스트레이션과 트랜잭셔널 메시징

-   오케스트레이션 사가는 DB를 업데이트하는 서비스와 메시지를 발생하는 서비스가 단계마다 있음.

### 오케스트레이션 사가의 장단점

#### 장점

-   의존 관계 단순화: 오케스트레이터는 참여자에게 의존하지만, 그 반대는 성립하지 않으므로 순환 의존성은 발생하지 않음.
-   낮은 결합도: 각 서비스는 오케스트레이터가 호출하는 API를 구현, 사가 참여자가 발행하는 이벤트는 몰라도 됨.
-   관심사를 더 분리하고, 비즈니스 로직을 단순화: 사가 편성 로직이 사가 오케스트레이터 한곳에만 있으므로 도메인 객체는 더 단순해지고 자신이 참여한 사가에 대해서는 알지 못함.

#### 단점

-   비즈니스 로직을 오케스트레이터에 너무 많이 중앙화될 수 있음.
    -   오케스트레이터가 순서화만 담당.
    -   비즈니스 로직은 갖고 있지 않도록 설계
