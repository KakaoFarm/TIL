# 2.2 마이크로서비스 아키텍처 정의

## 아키텍처 정의

1. 애플리케이션 요건을 핵심요청으로 추출
    - 시스템 작업은 애플리케이션이 처리하는 요청을 추상화한 것.
2. 어떻게 여러 서비스로 분해할지 결정.
3. 서비스별로 API 정의.

<br />

## 분해 과정의 장애물

1. 네트워크 지연(network latency)
2. 서비스 간 동기 통신으로 인해 가용성이 떨어짐. -> 자기 완비형 서비스로 해결
3. 여러 서비스에 걸쳐 데이터 일관성을 지키는 요건. -> 보통 사가로 해결
4. 애플리케이션 도처에 숨어 있는 만능 클래스 -> DDD 개념 활용

<br />

## 2.2.1 시스템 작업 식별

### 시스템 작업

-   1단계: 시스템 작업을 기술하기 위해 필요한 보케블러리를 제공하는 핵심 클래스로 구성된 고수준의 도메인 모델을 생성.
-   2단계: 시스템 작업 식별 후 그 동작을 도메인 모델 관점에서 기술

도메인 모델은 주로 사용자 스토리의 명사에서, 시스템 작업은 주로 동사에서 도출.

### 고수준 도메인 모델 생성

도메인 모델은 스토리에 포함된 명사를 분석하고, 도메인 전문가와 상담하는 등 표준 기법을 활용하여 생성

### 시스템 작업 정의

애플리케이션이 어떤 요청을 처리할지 식별하는 단계

#### 시스템 작업의 종류

시스텀 커맨드를 식별하려면 사용자 스토리/시나리오에 포함된 동사를 먼저 분석

-   커맨드(command): 데이터 생성, 수정, 삭제
    -   매개변수, 반환값, 동작 방식의 명세를 도메인 모델 클래스로 정의
    -   명세는 작업 호출 시 충족되어야 할 선행조건, 작업 호출 후 충족되어야 할 후행 조건으로 구성
-   쿼리(query): 데이터 읽기

<br />

## 2.2.2 서비스 정의: 비즈니스 능력 패턴별 분해

비즈니스 능력에 따라 서비스를 정의

### 비즈니스 능력은 곧 조직이 하는 일이다.

-   비즈니스 능력을 보면 조직의 비즈니스가 무엇을 하는지 알 수 있음

### 비즈니스 능력 식별

-   한 조직의 비즈니스 능력은 조직의 목표, 구조, 비즈니스 프로세스를 분석하여 식별.
-   비즈니스 능력은 보통 특정 비즈니스 객체에 집중하며, 여러 개의 하위 능력으로 분해할 수 있음.

### 비즈니스 능력을 여러 서비스로

-   비즈니스 능력을 식별한 후 능력에 따라 또는 연관된 능력 그룹에 따라 서비스를 정의
-   서비스를 거의 변하지 않는 비즈니스 능력에 따라 구성할 시 비교적 안정적인 아키텍처를 구축할 수 있음.

<br />

## 2.2.3 서비스 정의: 하위 도메인 패턴별 분해

DDD : 객체 지향 도메인 모델 중심의 복잡한 소프트웨어 애플리케이션을 구축하는 방법.

-   도메인 내부에서 문제 해결이 가능한 형태로 도메인을 모델링.
-   팀에서 사용할 보케블러리, 즉 공용 언어(ubiquitous language)를 정의
-   도메인을 구성하는 각 하위 도메인마다 도메인 모델을 따로 정의.

경계 컨텍스트(bounded context): 도메인 모델의 범위를 DDD 용어로 표현시.

장점: 마이크로서비스 아키텍처의 서비스와 잘 맞고, 자체 도메인 모델을 가진 하위 도메인이라는 개념 덕분에 만능 클래스를 제거하고 서비스로 분해하기가 더 수월.

<br />

## 2.2.4 분해 지침

비즈니스 능력에 따른 분해, 하위 도메인에 따른 분해는 마이크로서비스 아키텍처를 정의하는 주요 수단.

### 단일 책임 원칙

SRP에 따라 단일 책임을 가진, 즉 변경 사유가 오직 하나인 클래스를 정의.

### 공통 폐쇄 원칙

```
패키지의 클래스들은 동일한 유형의 변경에 대해 닫혀 있어야 한다.
패키지에 영향을 주는 변경은 그 패키지에 속한 모든 클래스에 영향을 끼친다.
- 로버트 C. 마틴
```

-   어떤 두 클래스가 동일한 사유로 맞물려 변경되면 동일한 패키지에 있어야 한다.
-   동일한 사유로 변경되는 컴포넌트를 모두 같은 서비스로 묶기.

<br />

## 2.2.5 서비스 분해의 장애물

### 네트워크 지연

-   서비스를 여러 개로 나누면 서비스 간 왕복 횟수 증가.

### 동기 IPC로 인한 가용성 저하

-   타 서비스 중 하나라도 불능일 경우 API 불능, REST 같은 프로토콜은 가용성이 떨어짐.

### 여러 서비스에 걸쳐 데이터 일관성 유지

-   과거에는 커밋 방식의 2단계(2PC) 분산 트랜잭션을 많이 썼지만, 요즘 애플리케이션에는 잘 안 맞기 때문에 사가(saga) 라는 전혀 다른 방식으로 트랜잭션을 관리.
-   사가는 메시징을 이용한 일련의 로컬 트랜잭션.

### 일관된 데이터 뷰 확보

-   여러 DB에 걸쳐 일관된 데이터 뷰를 확보하기 어려움.

### 만능 클래스는 분해의 걸림돌

-   만능 클래스 : 애플리케이션의 여러 측면에 관한 비즈니스 로직, 많은 필드가 다수의 컬럼을 가진 DB 테이블에 매핑
-   단단히 결합되어 있어 스키마를 변경 시 큰 수정 필요.
